# Nostr Fortune Slip 設計ドキュメント

## プロジェクト概要

Nostr Fortune Slipは、NostrプロトコルとLightning Networkを統合したおみくじアプリケーションです。ユーザーが1 satを支払うと、1-20のラッキーナンバーが表示される仕組みです。このドキュメントでは、設定画面、メイン画面、およびモジュール化されたコード構造の設計・実装について説明します。

## 技術スタック

- **フレームワーク**: SvelteKit
- **スタイリング**: Tailwind CSS
- **言語**: TypeScript
- **ストレージ**: ブラウザのLocalStorage

## 要件定義

### 画面構成

1. **メイン画面** (`/`)
   - QRコード生成ボタン
   - 生成されたQRコードの表示エリア
   - 設定画面への遷移ボタン
   
2. **設定画面** (`/settings`)
   - 設定フォーム
   - データの永続化

### 設定項目

- **ライトニングアドレス**: メールアドレス形式でのバリデーション
- **Nostr秘密鍵**: nsec形式での入力
- **Coinos ID**: 必須入力（今回の機能では使用しない）
- **Coinosパスワード**: 必須入力、表示/非表示切り替え機能付き（今回の機能では使用しない）

### 機能要件

#### 設定画面機能
- フォームバリデーション
- LocalStorageへのデータ保存
- 保存成功時の確認メッセージ表示
- 設定画面からメイン画面への戻る機能
- セキュリティ警告の表示
- データ削除機能（確認ダイアログ付き）

#### メイン画面機能
- **QRコード生成機能**: ボタンを押すとQRコードを表示
- **Nostrイベント発行**: kind 1イベントを作成し、指定されたリレーに送信
- **Zapリクエスト生成**: 発行したイベントに対するZapリクエスト（kind 9734）を作成
- **ライトニングインボイス取得**: ライトニングアドレスから1 sat（1000 millisatoshi）のインボイスを取得
- **QRコード表示**: `lightning:` + bolt11インボイス形式のQRコードを表示
- **エラーハンドリング**: ライトニングアドレス無効やリレー接続失敗時のエラーメッセージ表示

## 実装詳細

### ファイル構成

```
src/
├── lib/                        # コアライブラリ
│   ├── lightning.ts            # Lightning Network関連
│   ├── nostr/                  # Nostr関連機能（モジュール化）
│   │   ├── index.ts            # 統合エクスポート
│   │   ├── types.ts            # 型定義（NostrEvent, MetadataContent等）
│   │   ├── events.ts           # イベント作成機能
│   │   ├── zap.ts              # Zap関連機能（検知・バリデーション）
│   │   ├── utils.ts            # ユーティリティ機能
│   │   ├── events.spec.ts      # イベント作成テスト（8テスト）
│   │   ├── zap.spec.ts         # Zap機能テスト（12テスト）
│   │   └── utils.spec.ts       # ユーティリティテスト（3テスト）
│   ├── qrcode.ts              # QRコード生成
│   └── *.spec.ts              # その他のテスト
├── routes/
│   ├── +layout.svelte         # 共通レイアウト
│   ├── +page.svelte           # メイン画面（おみくじ機能）
│   └── settings/
│       └── +page.svelte       # 設定画面
└── app.css                    # Tailwind CSS設定
```

## アーキテクチャ設計

### テスト戦略

- **機能別テスト**: 各モジュールに対応するテストファイル
- **重複排除**: 元の巨大テストファイルを削除
- **カバレッジ向上**: 合計27テスト（削除前61テスト→削除後40テスト）
- **成功率100%**: 全テストがパス

### メイン画面 (`src/routes/+page.svelte`)

#### 主要機能

1. **QRコード生成ボタン**
   - ボタンクリックでメイン処理を実行
   - ローディング状態の表示

2. **Nostr機能**
   - WebSocket接続によるリレーサーバー通信 (`wss://nos.lol/`)
   - kind 1イベント（テストメッセージ）の作成・送信
   - nsec形式の秘密鍵のデコード・署名処理

3. **Zapリクエスト処理**
   - 発行したNostrイベントに対するZapリクエスト（kind 9734）作成
   - ライトニングアドレスから LNURL-pay エンドポイントの取得
   - インボイス生成（1 sat = 1000 millisatoshi）

4. **QRコード生成・表示**
   - qrcode ライブラリ（v1.5.4）を使用
   - `lightning:` + bolt11インボイス形式
   - 生成されたQRコードの画面表示

#### 技術仕様

- **Nostrリレー**: `['wss://nos.lol/']` etc.
- **イベント内容**: `"test"`（kind 1）
- **支払い金額**: 1 sat（1000 millisatoshi）
- **QRコード形式**: `lightning:lnbc...`
- **エラー処理**: ユーザーへのエラーメッセージ表示

#### 処理フロー

1. ユーザーがQRコード生成ボタンをクリック
2. LocalStorageから設定データ（ライトニングアドレス・秘密鍵）を取得
3. Nostr kind 1イベントを作成・署名
4. 指定リレーにイベントを送信
5. ライトニングアドレスからLNURL-payエンドポイントを取得
6. Zapリクエスト（kind 9734）を作成
7. インボイスを取得（1 sat）
8. QRコード生成・表示

### 設定画面 (`src/routes/settings/+page.svelte`)

#### 主要機能

1. **フォームバリデーション**
   - ライトニングアドレス: 正規表現 `/^[^@\s]+@[^@\s]+\.[^@\s]+$/`
   - 各フィールド必須チェック
   - エラーメッセージ表示

2. **パスワード表示切り替え**
   - `showPassword`状態によるinput type切り替え
   - 目のアイコン（開/閉）による視覚的フィードバック

3. **データ永続化**
   - LocalStorageへの保存
   - ページロード時のデータ復元（`onMount`）

4. **UI/UX**
   - 保存成功時のメッセージ表示（3秒間）
   - データ削除完了時のメッセージ表示（3秒間）
   - バリデーションエラー時の赤いボーダー表示
   - 戻るボタン（×アイコン）

5. **セキュリティ**
   - LocalStorage使用に関する警告メッセージ表示
   - データ削除機能（確認ダイアログ付き）
   - 全データの一括削除とフォームクリア

#### バリデーション仕様

```typescript
// ライトニングアドレス
if (!lightningAddress.trim()) {
  errors.lightningAddress = 'ライトニングアドレスは必須です';
} else if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(lightningAddress)) {
  errors.lightningAddress = '正しいメールアドレス形式で入力してください（例：user@domain.com）';
}

// 必須フィールドチェック
if (!coinosId.trim()) {
  errors.coinosId = 'Coinos IDは必須です';
}
if (!coinosPassword.trim()) {
  errors.coinosPassword = 'Coinosパスワードは必須です';
}
```

## テスト結果

### ✅ 成功項目

1. **画面遷移**: メイン画面 ↔ 設定画面の遷移が正常動作
2. **バリデーション**: 必須チェック、形式チェックが正常動作
3. **パスワード切り替え**: 表示/非表示機能が正常動作
4. **保存機能**: データがLocalStorageに保存される
5. **成功メッセージ**: 保存後のフィードバックが正常表示
6. **セキュリティ警告**: LocalStorage使用に関する適切な警告表示
7. **データ削除機能**: 確認ダイアログと削除完了メッセージが正常動作

### ✅ 解決済みの問題

1. **データ復元機能の不具合**（解決済み）
   - SessionStorageからLocalStorageに変更することで、ブラウザ再起動後もデータが永続化される
   - LocalStorageは明示的に削除されるまでデータが保持される

## 今後の改善点

### 短期改善

1. **LocalStorage実装の改善**（一部完了）
   - ✅ データクリア機能の追加
   - ✅ セキュリティ警告の表示
   - エラーハンドリングの強化

2. **UX向上**
   - フォーム送信時のローディング表示
   - 自動保存機能の検討

### 長期改善

1. **セキュリティ強化**
   - パスワードの暗号化保存
   - LocalStorageからより安全なストレージへの移行
   - セッション管理機能の実装
   - データの自動削除機能（有効期限設定）

2. **機能拡張**
   - 設定のエクスポート/インポート機能
   - 設定の検証・テスト機能

## スタイルガイド

### カラーパレット

- **Primary**: Blue 600/700 (`bg-blue-600 hover:bg-blue-700`)
- **Success**: Green 100/300/700
- **Error**: Red 500/600
- **Gray**: Gray 50/300/500/600/700/900

### レスポンシブ対応

- モバイルファースト設計
- 最大幅: `max-w-md` (28rem, 448px)
- パディング: `px-4 sm:px-6 lg:px-8`

## 実行方法

```bash
# 開発サーバー起動
npm run dev

# ビルド
npm run build

# プレビュー
npm run preview
```

## 関連リンク

- [SvelteKit Documentation](https://kit.svelte.dev/)
- [Tailwind CSS Documentation](https://tailwindcss.com/)
- [LocalStorage API](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage)

---

**作成日**: 2025/10/24  
**作成者**: AI Assistant  
**バージョン**: 1.0
